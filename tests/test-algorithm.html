<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algorithm Test Suite</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        .test-pass {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }
        .test-fail {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        .test-info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #667eea;
            color: white;
        }
        tr:hover {
            background: #f5f5f5;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        .stat-box {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
            margin: 0 10px;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>üß™ Gear Calculator Algorithm Test Suite</h1>
    
    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
        <button onclick="testGearDetection()">üîç Test 2-Gear Detection</button>
        <button onclick="testErrorScoring()">üéØ Test Error Scoring</button>
        <button onclick="testRealWorldErrorSelection()">üé≤ Test Real-World Error Selection</button>
        <button onclick="testScoring()">üìä Test Full Scoring</button>
        <button onclick="testOptimization()">‚öôÔ∏è Test Optimization</button>
        <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
    </div>

    <div id="results"></div>

    <script src="../js/calculator.js"></script>
    <script>
        let testResults = [];

        function log(message, type = 'info') {
            const resultDiv = document.getElementById('results');
            const testDiv = document.createElement('div');
            testDiv.className = `test-result test-${type}`;
            testDiv.textContent = message;
            resultDiv.appendChild(testDiv);
            
            testResults.push({ message, type });
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testResults = [];
        }

        function assert(condition, message) {
            if (condition) {
                log(`‚úì PASS: ${message}`, 'pass');
                return true;
            } else {
                log(`‚úó FAIL: ${message}`, 'fail');
                return false;
            }
        }

        function testGearDetection() {
            clearResults();
            log('=== Testing 2-Gear Solution Detection ===', 'info');

            // Test 2-gear solution structure
            const twoGearSolution = {
                Gears: [40, null, null, 80],
                TPI: 8.0,
                Pitch: 3.175
            };

            const fourGearSolution = {
                Gears: [40, 60, 80, 72],
                TPI: 8.0,
                Pitch: 3.175
            };

            log(`2-gear solution structure: [${twoGearSolution.Gears.join(', ')}]`, 'info');
            log(`4-gear solution structure: [${fourGearSolution.Gears.join(', ')}]`, 'info');

            // Test detection logic
            const is2Gear = (twoGearSolution.Gears[1] === null && twoGearSolution.Gears[2] === null);
            const is4Gear = !(fourGearSolution.Gears[1] === null && fourGearSolution.Gears[2] === null);

            assert(is2Gear === true, '2-gear solution correctly detected');
            assert(is4Gear === true, '4-gear solution correctly identified as not 2-gear');

            // Test with real calculator
            log('\n=== Testing with Real Calculator ===', 'info');
            const calc = new GearCalculator();
            const gears = [20, 21, 25, 30, 35, 40, 45, 48, 50, 54, 55, 57, 60, 65, 72, 80];

            const solutions = calc.getGears({
                gears: gears,
                tpi: 8,
                leadscrew_tpi: 16
            });

            log(`Found ${solutions.length} solutions for 8 TPI`, 'info');

            let twoGearCount = 0;
            let fourGearCount = 0;

            solutions.slice(0, 10).forEach((sol, idx) => {
                const is2Gear = (sol.Gears[1] === null && sol.Gears[2] === null);
                if (is2Gear) twoGearCount++;
                else fourGearCount++;

                log(`Solution ${idx + 1}: [${sol.Gears.map(g => g === null ? 'null' : g).join(', ')}] - ${is2Gear ? '2-GEAR ‚úì' : '4-GEAR'}`, is2Gear ? 'pass' : 'info');
            });

            log(`\nTotal in first 10: ${twoGearCount} two-gear, ${fourGearCount} four-gear`, 'info');
            assert(twoGearCount > 0, 'At least one 2-gear solution found');

            return { twoGearCount, fourGearCount, total: solutions.length };
        }

        function testErrorScoring() {
            clearResults();
            log('=== Testing Error-Based Scoring ===', 'info');

            // Create three solutions with different error percentages
            const target = { type: 'tpi', value: 8.0 };

            const lowErrorSolution = {
                Gears: [40, null, null, 80],
                TPI: 8.001,  // 0.0125% error
                Pitch: 3.175
            };

            const medErrorSolution = {
                Gears: [45, null, null, 72],
                TPI: 8.00485,  // 0.0606% error
                Pitch: 3.175
            };

            const highErrorSolution = {
                Gears: [50, null, null, 65],
                TPI: 8.00699,  // 0.0874% error
                Pitch: 3.175
            };

            // Calculate actual errors
            const lowError = Math.abs((lowErrorSolution.TPI - target.value) / target.value * 100);
            const medError = Math.abs((medErrorSolution.TPI - target.value) / target.value * 100);
            const highError = Math.abs((highErrorSolution.TPI - target.value) / target.value * 100);

            log(`Low error solution: [${lowErrorSolution.Gears.join(', ')}]`, 'info');
            log(`  TPI: ${lowErrorSolution.TPI}, Error: ${lowError.toFixed(4)}%`, 'info');

            log(`\nMed error solution: [${medErrorSolution.Gears.join(', ')}]`, 'info');
            log(`  TPI: ${medErrorSolution.TPI}, Error: ${medError.toFixed(4)}%`, 'info');

            log(`\nHigh error solution: [${highErrorSolution.Gears.join(', ')}]`, 'info');
            log(`  TPI: ${highErrorSolution.TPI}, Error: ${highError.toFixed(4)}%`, 'info');

            // Simulate scoring (simplified - just error component)
            const gearFrequency = {};
            const selectedGears = {};

            const scoreLow = 100000 * Math.exp(-lowError * 10);
            const scoreMed = 100000 * Math.exp(-medError * 10);
            const scoreHigh = 100000 * Math.exp(-highError * 10);

            log(`\nError-based scores:`, 'info');
            log(`  Low error (${lowError.toFixed(4)}%): ${scoreLow.toFixed(0)} points`, 'info');
            log(`  Med error (${medError.toFixed(4)}%): ${scoreMed.toFixed(0)} points`, 'info');
            log(`  High error (${highError.toFixed(4)}%): ${scoreHigh.toFixed(0)} points`, 'info');

            log(`\nScore differences:`, 'info');
            log(`  Low vs Med: ${(scoreLow - scoreMed).toFixed(0)} points`, 'info');
            log(`  Low vs High: ${(scoreLow - scoreHigh).toFixed(0)} points`, 'info');
            log(`  Med vs High: ${(scoreMed - scoreHigh).toFixed(0)} points`, 'info');

            // Assertions
            assert(lowError < medError, 'Low error should be less than medium error');
            assert(medError < highError, 'Medium error should be less than high error');
            assert(scoreLow > scoreMed, 'Low error should score higher than medium error');
            assert(scoreMed > scoreHigh, 'Medium error should score higher than high error');
            assert(scoreLow > scoreHigh, 'Low error should score higher than high error');

            // Check that error scoring dominates (should be > 10,000 point difference)
            const lowMedDiff = scoreLow - scoreMed;
            const medHighDiff = scoreMed - scoreHigh;
            assert(lowMedDiff > 100, 'Error differences should be significant (>100 points)');
            assert(medHighDiff > 100, 'Error differences should be significant (>100 points)');

            log(`\n‚úì Error-based scoring working correctly!`, 'pass');
            log(`  Lower error = higher score`, 'pass');
            log(`  Differences are significant`, 'pass');

            return { scoreLow, scoreMed, scoreHigh, lowError, medError, highError };
        }

        function testScoring() {
            clearResults();
            log('=== Testing Full Scoring Algorithm ===', 'info');

            const twoGearSolution = {
                Gears: [40, null, null, 80],
                TPI: 8.0,
                Pitch: 3.175
            };

            const fourGearSolution = {
                Gears: [40, 60, 80, 72],
                TPI: 8.0,
                Pitch: 3.175
            };

            // Simulate scoring
            const gearFrequency = {
                'pos0_40': 10,
                'pos1_60': 5,
                'pos2_80': 8,
                'pos3_72': 12,
                'pos3_80': 15
            };

            const selectedGears = {};

            // Score 2-gear solution
            let score2 = 0;
            const is2Gear = (twoGearSolution.Gears[1] === null && twoGearSolution.Gears[2] === null);
            if (is2Gear) score2 += 10000000;
            for (let i = 0; i < 4; i++) {
                const gear = twoGearSolution.Gears[i];
                if (gear !== null && gear !== undefined) {
                    score2 += (gearFrequency[`pos${i}_${gear}`] || 0) * 10;
                }
            }

            // Score 4-gear solution
            let score4 = 0;
            const is4Gear = !(fourGearSolution.Gears[1] === null && fourGearSolution.Gears[2] === null);
            for (let i = 0; i < 4; i++) {
                const gear = fourGearSolution.Gears[i];
                if (gear !== null && gear !== undefined) {
                    score4 += (gearFrequency[`pos${i}_${gear}`] || 0) * 10;
                }
            }

            log(`2-gear solution: [${twoGearSolution.Gears.join(', ')}]`, 'info');
            log(`  2-gear bonus applied: ${is2Gear ? 'YES ‚úì' : 'NO ‚úó'}`, is2Gear ? 'pass' : 'fail');
            log(`  Total score: ${score2.toLocaleString()}`, 'info');

            log(`\n4-gear solution: [${fourGearSolution.Gears.join(', ')}]`, 'info');
            log(`  2-gear bonus applied: ${is4Gear ? 'NO (correct)' : 'YES (wrong)'}`, !is4Gear ? 'fail' : 'pass');
            log(`  Total score: ${score4.toLocaleString()}`, 'info');

            log(`\nComparison:`, 'info');
            log(`  2-gear: ${score2.toLocaleString()} ${score2 > score4 ? '‚úì WINS' : '‚úó LOSES'}`, score2 > score4 ? 'pass' : 'fail');
            log(`  4-gear: ${score4.toLocaleString()}`, 'info');
            log(`  Difference: ${(score2 - score4).toLocaleString()} points`, 'info');

            assert(is2Gear === true, '2-gear solution correctly identified');
            assert(score2 > 10000000, '2-gear bonus applied (+10M points)');
            assert(score2 > score4, '2-gear scores higher than 4-gear');
            assert(score2 / score4 > 1000, '2-gear scores MUCH higher (1000x+)');

            return { score2, score4, ratio: score2 / score4 };
        }

        function testRealWorldErrorSelection() {
            clearResults();
            log('=== Testing Real-World Error Selection ===', 'info');

            const calc = new GearCalculator();
            const gears = [20, 21, 25, 30, 35, 40, 45, 48, 50, 54, 55, 57, 60, 65, 72, 80];

            // Test a specific TPI where we know multiple solutions exist with different errors
            const testTPI = 12;
            const solutions = calc.getGears({
                gears: gears,
                tpi: testTPI,
                leadscrew_tpi: 16
            });

            log(`Testing TPI: ${testTPI}`, 'info');
            log(`Found ${solutions.length} solutions`, 'info');

            // Show top 5 solutions with their errors
            log(`\nTop 5 solutions by error:`, 'info');
            const top5 = solutions.slice(0, 5);
            top5.forEach((sol, idx) => {
                const error = Math.abs((sol.TPI - testTPI) / testTPI * 100);
                const gearStr = sol.Gears.map(g => g === null ? 'ANY' : g).join('-');
                log(`  ${idx + 1}. [${gearStr}] TPI: ${sol.TPI.toFixed(6)}, Error: ${error.toFixed(4)}%`, 'info');
            });

            // Verify that solutions are sorted by error (lowest first)
            for (let i = 0; i < top5.length - 1; i++) {
                const error1 = Math.abs((top5[i].TPI - testTPI) / testTPI * 100);
                const error2 = Math.abs((top5[i + 1].TPI - testTPI) / testTPI * 100);

                // Allow for very small differences due to floating point
                if (error1 > error2 + 0.0001) {
                    log(`\n‚úó Solutions not sorted by error!`, 'fail');
                    log(`  Solution ${i + 1} error: ${error1.toFixed(6)}%`, 'fail');
                    log(`  Solution ${i + 2} error: ${error2.toFixed(6)}%`, 'fail');
                    assert(false, 'Solutions should be sorted by error (lowest first)');
                    return;
                }
            }

            const lowestError = Math.abs((top5[0].TPI - testTPI) / testTPI * 100);
            log(`\n‚úì Solutions correctly sorted by error`, 'pass');
            log(`  Lowest error: ${lowestError.toFixed(4)}%`, 'pass');

            return { testTPI, solutionCount: solutions.length, lowestError };
        }

        function testOptimization() {
            clearResults();
            log('=== Testing Full Optimization ===', 'info');

            // Test with a small set of threads
            const testThreads = [8, 12, 16, 20];
            const gears = [20, 21, 25, 30, 35, 40, 45, 48, 50, 54, 55, 57, 60, 65, 72, 80];

            log(`Testing optimization for ${testThreads.length} threads: ${testThreads.join(', ')} TPI`, 'info');

            const calc = new GearCalculator();
            let total2Gear = 0;
            let total4Gear = 0;

            testThreads.forEach(tpi => {
                const solutions = calc.getGears({
                    gears: gears,
                    tpi: tpi,
                    leadscrew_tpi: 16
                });

                if (solutions.length > 0) {
                    const best = solutions[0]; // First solution should be best
                    const is2Gear = (best.Gears[1] === null && best.Gears[2] === null);

                    if (is2Gear) total2Gear++;
                    else total4Gear++;

                    log(`${tpi} TPI: [${best.Gears.map(g => g === null ? 'ANY' : g).join(', ')}] - ${is2Gear ? '2-GEAR ‚úì' : '4-GEAR'}`, is2Gear ? 'pass' : 'info');
                }
            });

            const percent2Gear = (total2Gear / testThreads.length * 100).toFixed(1);
            log(`\nResults: ${total2Gear}/${testThreads.length} are 2-gear (${percent2Gear}%)`, 'info');

            assert(total2Gear > 0, 'At least some 2-gear solutions selected');
            assert(total2Gear >= total4Gear, 'More 2-gear than 4-gear solutions (or equal)');

            return { total2Gear, total4Gear, percent: percent2Gear };
        }

        function runAllTests() {
            clearResults();
            log('üß™ Running All Tests...', 'info');
            log('', 'info');

            const results = {};

            // Run tests sequentially
            results.detection = testGearDetection();

            setTimeout(() => {
                results.errorScoring = testErrorScoring();

                setTimeout(() => {
                    results.realWorldError = testRealWorldErrorSelection();

                    setTimeout(() => {
                        results.scoring = testScoring();

                        setTimeout(() => {
                            results.optimization = testOptimization();

                            setTimeout(() => {
                                // Summary
                                log('\n' + '='.repeat(50), 'info');
                                log('üìä TEST SUMMARY', 'info');
                                log('='.repeat(50), 'info');

                                const passed = testResults.filter(r => r.type === 'pass').length;
                                const failed = testResults.filter(r => r.type === 'fail').length;
                                const total = passed + failed;

                                log(`Total Tests: ${total}`, 'info');
                                log(`Passed: ${passed} ‚úì`, 'pass');
                                if (failed > 0) {
                                    log(`Failed: ${failed} ‚úó`, 'fail');
                                }
                                log(`Success Rate: ${(passed/total*100).toFixed(1)}%`, passed === total ? 'pass' : 'fail');

                                // Export results for command-line
                                window.testResults = {
                                    passed,
                                    failed,
                                    total,
                                    details: results
                                };
                            }, 100);
                        }, 100);
                    }, 100);
                }, 100);
            }, 100);
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            log('Test suite loaded. Click "Run All Tests" to begin.', 'info');
        });
    </script>
</body>
</html>

